<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doral Video Conference</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Lato:wght@400;700&display=swap');
        body {
            font-family: 'Lato', sans-serif;
            background-color: #282828;
            color: #ebdbb2;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://i.postimg.cc/9fYYq5K9/image.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .header {
            background-color: #1d2021;
            color: #ebdbb2;
        }
        .container-card {
            background-color: #32302f;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #458588;
            color: #ebdbb2;
        }
        .btn-danger {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #fb4934;
            color: #ebdbb2;
        }
        .btn-toggle {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #504945;
            color: #ebdbb2;
        }
        .btn-toggle-active {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #b8bb26;
            color: #1d2021;
        }
        .input-field {
            @apply w-full px-4 py-3 rounded-sm border border-gray-600 focus:outline-none focus:ring-2 transition duration-200;
            background-color: #32302f;
            color: #ebdbb2;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #1d2021;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .video-element {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease-in-out;
        }
        #localVideo {
            width: 150px;
            height: 112.5px;
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            border-radius: 0.25rem;
            z-index: 10;
            border: 2px solid #ebdbb2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        #remoteVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease-in-out;
            z-index: 5;
        }
        .chat-container {
            background-color: #3c3836;
            border: 1px solid #504945;
            border-radius: 0.5rem;
            height: 500px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        .my-message {
            background-color: #458588;
            color: #ebdbb2;
            align-self: flex-end;
        }
        .other-message {
            background-color: #665c54;
            color: #ebdbb2;
            align-self: flex-start;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #32302f;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 400px;
        }
        .sakura-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 20;
        }
        .sakura-petal {
            position: absolute;
            background: rgba(255, 192, 203, 0.8);
            border-radius: 50%;
            width: 10px;
            height: 10px;
            animation: falling 15s linear infinite;
        }
        @keyframes falling {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
    <!-- Header -->
    <header class="header w-full py-4 mb-8 flex flex-col sm:flex-row items-center justify-between px-6 shadow-md">
        <div class="flex items-center">
            <img src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="School Logo" class="h-12 mr-4">
            <div class="flex flex-col items-start">
                <h1 class="text-3xl sm:text-4xl font-semibold font-['Crimson_Pro']">
                    Doral Video Conference
                </h1>
                <p class="text-sm font-light text-gray-400 mt-1">Created by Coach Prebeg</p>
            </div>
        </div>
        <div class="text-sm mt-2 sm:mt-0 font-light" id="auth-status">Authenticating...</div>
    </header>

    <!-- Login Prompt -->
    <div id="loginPrompt" class="md:col-span-3 flex flex-col items-center justify-center p-8 bg-[#32302f] rounded-lg shadow-xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4/5 md:w-1/2">
        <h2 class="text-2xl font-bold font-['Crimson_Pro'] mb-4">Login</h2>
        <p class="text-sm text-gray-400 mb-6 text-center">Enter name below to proceed into the waiting room.</p>
        <input type="text" id="usernameInput" placeholder="Username" class="input-field max-w-sm mb-4" />
        <div class="flex items-center space-x-2 mb-4">
            <input type="checkbox" id="adminLoginCheckbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
            <label for="adminLoginCheckbox" class="text-sm">Login as Admin</label>
        </div>
        <button id="submitLoginBtn" class="btn-primary max-w-xs w-full">Login</button>
    </div>

    <!-- Main App Content (for regular users, hidden initially) -->
    <main id="mainApp" class="w-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-[1fr_2fr_1fr] md:gap-8 hidden">
        <!-- Left Sidebar for Chat -->
        <div class="space-y-8">
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Chat</h2>
                <div class="chat-container mb-4" id="chatContainer"></div>
                <div class="flex space-x-2 items-center">
                    <input type="file" id="fileInput" class="hidden" />
                    <button id="fileUploadBtn" class="btn-toggle"><i class="fas fa-paperclip"></i></button>
                    <input type="text" id="chatInput" placeholder="Send a message..." class="input-field flex-1" />
                    <button id="sendChatBtn" class="btn-primary" disabled>Send</button>
                </div>
            </div>
        </div>

        <!-- Video and Controls -->
        <div class="container-card">
            <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Video Feed</h2>
            <div class="video-container mb-4">
                <video id="remoteVideo" class="video-element" autoplay playsinline></video>
                <video id="localVideo" class="video-element" autoplay playsinline muted></video>
                <div id="sakuraEffect" class="sakura-container hidden"></div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center">
                <button id="toggleAudioBtn" class="btn-toggle" disabled><i class="fas fa-microphone"></i> Mute Audio</button>
                <button id="toggleVideoBtn" class="btn-toggle" disabled><i class="fas fa-video"></i> Mute Video</button>
                <button id="screenShareBtn" class="btn-toggle" disabled><i class="fas fa-desktop"></i> Screen Share</button>
                <button id="fullScreenBtn" class="btn-toggle" disabled><i class="fas fa-expand"></i> Fullscreen</button>
                <button id="sideBySideBtn" class="btn-toggle" disabled><i class="fas fa-columns"></i> Side-by-Side</button>
                <button id="hangupBtn" class="btn-danger flex-1" disabled>Leave Room</button>
            </div>
            <div class="flex mt-4 space-x-4 items-center justify-center">
                <i class="fas fa-volume-down text-lg"></i>
                <input type="range" id="volumeControl" min="0" max="100" value="100" class="flex-1 cursor-pointer">
                <i class="fas fa-volume-up text-lg"></i>
            </div>
            <div class="flex mt-4 space-x-4 justify-center">
                <button id="startRecordingBtn" class="btn-primary" disabled>Start Recording</button>
                <button id="stopRecordingBtn" class="btn-danger" disabled>Stop Recording</button>
            </div>
            <a id="downloadRecording" style="display: none;"></a>
        </div>

        <!-- Right Sidebar for Management -->
        <div class="space-y-8">
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Room Management</h2>
                <div class="flex flex-col space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="roomIdInput" placeholder="Enter Room ID" class="input-field flex-1" />
                        <button id="joinRoomBtn" class="btn-primary" disabled>Join</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="joinMutedCheckbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <label for="joinMutedCheckbox" class="text-sm">Join with camera/mic off</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="videoQualitySelect" class="text-sm">Video Quality:</label>
                        <select id="videoQualitySelect" class="input-field flex-1">
                            <option value="480p">SD (480p)</option>
                            <option value="720p">HD (720p)</option>
                            <option value="1080p">Full HD (1080p)</option>
                        </select>
                    </div>
                    <button id="createRoomBtn" class="btn-primary" disabled>Create New Room</button>
                    <button id="deleteAllRoomsBtn" class="btn-danger" disabled>Delete All Rooms</button>
                    <button id="lockRoomBtn" class="btn-toggle" disabled>Lock Room</button>
                </div>
            </div>
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Active Rooms</h2>
                <div id="activeRoomsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading rooms...</p>
                </div>
            </div>
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Participants</h2>
                <div id="participantsList" class="space-y-2 text-gray-400 text-sm">
                    No participants in this room.
                </div>
            </div>
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Active Users</h2>
                <div id="activeUsersList" class="space-y-2 text-gray-400 text-sm">
                    Loading users...
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Dashboard (hidden initially) -->
    <main id="adminDashboard" class="w-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
        <div class="container-card">
            <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Room Management</h2>
            <div class="flex flex-col space-y-4">
                <button id="adminDeleteAllRoomsBtn" class="btn-danger">Delete All Rooms</button>
                <button id="switchToUserModeBtn" class="btn-primary">Switch to User Mode</button>
                <div id="adminActiveRoomsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading rooms...</p>
                </div>
            </div>
        </div>
        <div class="container-card">
            <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Active Users</h2>
            <div id="adminActiveUsersList" class="space-y-2 text-gray-400 text-sm">
                <p>Loading users...</p>
            </div>
        </div>
        <div class="container-card">
            <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">System Status</h2>
            <div class="space-y-2 text-sm">
                <p><span class="font-semibold">Total Active Rooms:</span> <span id="totalRooms">0</span></p>
                <p><span class="font-semibold">Total Active Users:</span> <span id="totalUsers">0</span></p>
                <p><span class="font-semibold">Server Status:</span> <span id="serverStatus">Checking...</span></p>
            </div>
        </div>
    </main>

    <!-- Username Modal for Switching to User Mode -->
    <div id="usernameModal" class="modal-overlay hidden">
        <div class="modal-content flex flex-col space-y-4">
            <h2 class="text-xl font-bold font-['Crimson_Pro']">Enter Username</h2>
            <p class="text-sm text-gray-400">Please enter a username to switch to user mode.</p>
            <input type="text" id="switchUsernameInput" placeholder="Username" class="input-field" />
            <div class="flex space-x-4">
                <button id="confirmSwitchBtn" class="btn-primary flex-1">Confirm</button>
                <button id="cancelSwitchBtn" class="btn-toggle flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Password Modal (for admin actions and delete all rooms) -->
    <div id="passwordModal" class="modal-overlay hidden">
        <div class="modal-content flex flex-col space-y-4">
            <h2 class="text-xl font-bold font-['Crimson_Pro']" id="passwordModalTitle">Confirm Action</h2>
            <p class="text-sm text-gray-400" id="passwordModalText">Please enter the administrator password to proceed.</p>
            <input type="password" id="passwordInput" placeholder="Password" class="input-field" />
            <div class="flex space-x-4">
                <button id="confirmBtn" class="btn-danger flex-1" data-action="">Confirm</button>
                <button id="cancelBtn" class="btn-toggle flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Global Status Message -->
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center text-gray-700 bg-gray-100 hidden"></div>

    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };

        // Global variables
        const appId = firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth;
        let userId, username, isAdmin = false;
        let peerConnection = null, localStream = null, roomRef = null;
        let roomSnapshotListener = null, candidatesListener = null, chatListener = null, roomsListener = null, participantsListener = null, activeUsersListener = null;
        let isScreenSharing = false;
        let mediaRecorder, recordedChunks = [];
        let adminRoomsListener = null, adminUsersListener = null;

        // UI Elements
        const loginPrompt = document.getElementById('loginPrompt');
        const mainApp = document.getElementById('mainApp');
        const adminDashboard = document.getElementById('adminDashboard');
        const usernameInput = document.getElementById('usernameInput');
        const adminLoginCheckbox = document.getElementById('adminLoginCheckbox');
        const submitLoginBtn = document.getElementById('submitLoginBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdInput = document.getElementById('roomIdInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const deleteAllRoomsBtn = document.getElementById('deleteAllRoomsBtn');
        const lockRoomBtn = document.getElementById('lockRoomBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const screenShareBtn = document.getElementById('screenShareBtn');
        const fullScreenBtn = document.getElementById('fullScreenBtn');
        const sideBySideBtn = document.getElementById('sideBySideBtn');
        const videoQualitySelect = document.getElementById('videoQualitySelect');
        const volumeControl = document.getElementById('volumeControl');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const fileInput = document.getElementById('fileInput');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const statusMessage = document.getElementById('status-message');
        const authStatus = document.getElementById('auth-status');
        const activeRoomsList = document.getElementById('activeRoomsList');
        const joinMutedCheckbox = document.getElementById('joinMutedCheckbox');
        const participantsList = document.getElementById('participantsList');
        const activeUsersList = document.getElementById('activeUsersList');
        const sakuraEffect = document.getElementById('sakuraEffect');
        const passwordModal = document.getElementById('passwordModal');
        const passwordModalTitle = document.getElementById('passwordModalTitle');
        const passwordModalText = document.getElementById('passwordModalText');
        const passwordInput = document.getElementById('passwordInput');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const adminDeleteAllRoomsBtn = document.getElementById('adminDeleteAllRoomsBtn');
        const switchToUserModeBtn = document.getElementById('switchToUserModeBtn');
        const adminActiveRoomsList = document.getElementById('adminActiveRoomsList');
        const adminActiveUsersList = document.getElementById('adminActiveUsersList');
        const totalRooms = document.getElementById('totalRooms');
        const totalUsers = document.getElementById('totalUsers');
        const serverStatus = document.getElementById('serverStatus');
        const usernameModal = document.getElementById('usernameModal');
        const switchUsernameInput = document.getElementById('switchUsernameInput');
        const confirmSwitchBtn = document.getElementById('confirmSwitchBtn');
        const cancelSwitchBtn = document.getElementById('cancelSwitchBtn');

        // Video quality options
        const videoQualities = {
            '480p': { width: 640, height: 480 },
            '720p': { width: 1280, height: 720 },
            '1080p': { width: 1920, height: 1080 }
        };

        // WebRTC STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        // Show message
        const showMessage = (msg, isError = false) => {
            statusMessage.textContent = msg;
            statusMessage.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center transition-all duration-300 transform animate-fade-in ${isError ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100'}`;
            statusMessage.style.display = 'block';
        };

        // Hide message
        const hideMessage = () => {
            statusMessage.style.display = 'none';
        };

        // Initialize Firebase
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = isAdmin ? `Admin ID: ${userId}` : `User ID: ${userId}`;
                        if (isAdmin) {
                            listenForAdminRooms();
                            listenForAdminUsers();
                            checkServerStatus();
                        } else {
                            createRoomBtn.disabled = false;
                            joinRoomBtn.disabled = false;
                            deleteAllRoomsBtn.disabled = false;
                            listenForRooms();
                            listenForActiveUsers();
                        }
                    } else {
                        authStatus.textContent = 'Authenticating...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessage("Authentication failed.", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase initialization failed: ${error.message}`, true);
            }
        };

        // Handle login
        const handleLogin = async () => {
            const input = usernameInput.value.trim();
            if (!input) {
                showMessage("Please enter a username or password.", true);
                return;
            }

            if (adminLoginCheckbox.checked) {
                if (input === 'max') {
                    isAdmin = true;
                    loginPrompt.style.display = 'none';
                    adminDashboard.style.display = 'grid';
                    authStatus.textContent = `Admin ID: ${userId}`;
                    listenForAdminRooms();
                    listenForAdminUsers();
                    checkServerStatus();
                } else {
                    showMessage("Incorrect admin password.", true);
                }
            } else {
                username = input;
                loginPrompt.style.display = 'none';
                mainApp.style.display = 'grid';
                const activeUsersRef = doc(db, `artifacts/${appId}/public/data/active-users`, userId);
                await setDoc(activeUsersRef, { username: username, timestamp: serverTimestamp() });
            }
        };

        // Switch to user mode
        const switchToUserMode = async () => {
            usernameModal.classList.remove('hidden');
        };

        // Handle switch to user mode
        const handleSwitchToUserMode = async () => {
            const input = switchUsernameInput.value.trim();
            if (!input) {
                showMessage("Please enter a username.", true);
                return;
            }
            username = input;
            isAdmin = false;
            adminDashboard.style.display = 'none';
            mainApp.style.display = 'grid';
            authStatus.textContent = `User ID: ${userId}`;
            if (adminRoomsListener) adminRoomsListener();
            if (adminUsersListener) adminUsersListener();
            adminRoomsListener = null;
            adminUsersListener = null;
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            deleteAllRoomsBtn.disabled = false;
            listenForRooms();
            listenForActiveUsers();
            const activeUsersRef = doc(db, `artifacts/${appId}/public/data/active-users`, userId);
            await setDoc(activeUsersRef, { username: username, timestamp: serverTimestamp() });
            usernameModal.classList.add('hidden');
            switchUsernameInput.value = '';
            showMessage(`Switched to user mode as ${username}.`, false);
        };

        // Get local stream
        const getLocalStream = async (startMuted) => {
            try {
                const selectedQuality = videoQualitySelect.value;
                const constraints = {
                    audio: true,
                    video: videoQualities[selectedQuality]
                };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                localVideo.muted = true;

                if (startMuted) {
                    localStream.getAudioTracks()[0].enabled = false;
                    localStream.getVideoTracks()[0].enabled = false;
                    toggleAudioBtn.textContent = "Unmute Audio";
                    toggleVideoBtn.textContent = "Turn On Video";
                } else {
                    toggleAudioBtn.textContent = "Mute Audio";
                    toggleVideoBtn.textContent = "Mute Video";
                }
                toggleAudioBtn.classList.toggle('btn-toggle-active', !startMuted);
                toggleVideoBtn.classList.toggle('btn-toggle-active', !startMuted);
                toggleAudioBtn.disabled = false;
                toggleVideoBtn.disabled = false;
                fullScreenBtn.disabled = false;
                sideBySideBtn.disabled = false;
                lockRoomBtn.disabled = false;
                videoQualitySelect.disabled = false;
                screenShareBtn.disabled = false;
                return localStream;
            } catch (error) {
                console.error("Error getting user media:", error);
                if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    showMessage("Access to camera/microphone was denied. Please check your browser's settings.", true);
                } else {
                    showMessage("Could not access camera and microphone. Please grant permissions.", true);
                }
                return null;
            }
        };

        // Setup peer connection
        const setupPeerConnection = () => {
            peerConnection = new RTCPeerConnection(configuration);
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidatesCollection = collection(roomRef, 'candidates');
                    addDoc(candidatesCollection, { candidate: JSON.stringify(event.candidate.toJSON()), sender: userId });
                }
            };
            peerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    startRecordingBtn.disabled = false;
                }
            };
        };

        // Listen for rooms (user view)
        const listenForRooms = () => {
            if (roomsListener) roomsListener();
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            roomsListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                activeRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    activeRoomsList.innerHTML = '<p class="text-gray-500 text-sm">No active rooms.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const roomData = doc.data();
                        const roomName = doc.id;
                        const numParticipants = Object.keys(roomData.participants || {}).length;
                        const isOccupied = numParticipants > 1;
                        const statusIcon = isOccupied
                            ? '<i class="fas fa-lock text-red-500"></i>'
                            : '<i class="fas fa-check-circle text-green-500"></i>';
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-sm hover:bg-[#504945] transition duration-150 cursor-pointer';
                        roomDiv.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <span>${statusIcon}</span>
                                <div class="flex flex-col">
                                    <span class="font-semibold">${roomName}</span>
                                    <span class="text-xs text-gray-400">Created by: ${roomData.createdByUsername}</span>
                                </div>
                            </div>
                            <button data-room-id="${roomName}" class="join-room-btn px-3 py-1 text-sm rounded-sm bg-blue-600 text-white hover:bg-blue-700">Join</button>
                        `;
                        activeRoomsList.appendChild(roomDiv);
                    });
                    document.querySelectorAll('.join-room-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            roomIdInput.value = e.target.dataset.roomId;
                            joinRoom();
                        });
                    });
                }
            });
        };

        // Create room
        const createRoom = async () => {
            if (!userId) {
                showMessage("Authentication in progress. Please wait.", true);
                return;
            }
            const roomName = `room-${Math.random().toString(36).substring(2, 9)}`;
            roomIdInput.value = roomName;
            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomName);
            showMessage("Creating room...");
            try {
                const startMuted = joinMutedCheckbox.checked;
                const stream = await getLocalStream(startMuted);
                if (!stream) return;
                setupPeerConnection();
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                const participants = { 
                    [userId]: {
                        username: username,
                        isMuted: joinMutedCheckbox.checked,
                        isVideoOff: joinMutedCheckbox.checked
                    }
                };
                await setDoc(roomRef, {
                    offer: { sdp: offer.sdp, type: offer.type },
                    createdBy: userId,
                    createdByUsername: username,
                    participants: participants,
                    isLocked: false
                });
                roomSnapshotListener = onSnapshot(roomRef, async (snapshot) => {
                    const data = snapshot.data();
                    if (!snapshot.exists()) {
                        hangup();
                        showMessage("Room closed by host.", false);
                        return;
                    }
                    if (data && data.answer && !peerConnection.currentRemoteDescription) {
                        const answer = new RTCSessionDescription(data.answer);
                        await peerConnection.setRemoteDescription(answer);
                    }
                });
                candidatesListener = onSnapshot(collection(roomRef, 'candidates'), (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const candidate = new RTCIceCandidate(JSON.parse(change.doc.data().candidate));
                            await peerConnection.addIceCandidate(candidate);
                        }
                    });
                });
                listenForChat(roomRef);
                listenForParticipants();
                showMessage(`Room created! Share this ID with others: ${roomName}`);
                createRoomBtn.disabled = true;
                joinRoomBtn.disabled = true;
                hangupBtn.disabled = false;
                sendChatBtn.disabled = false;
            } catch (error) {
                console.error("Error creating room:", error);
                showMessage("Failed to create room. Please try again.", true);
            }
        };

        // Join room
        const joinRoom = async () => {
            if (!userId) {
                showMessage("Authentication in progress. Please wait.", true);
                return;
            }
            const roomId = roomIdInput.value;
            if (!roomId) {
                showMessage("Please enter a Room ID.", true);
                return;
            }
            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomId);
            const roomSnapshot = await getDoc(roomRef);
            if (!roomSnapshot.exists()) {
                showMessage("Room does not exist.", true);
                return;
            }
            const roomData = roomSnapshot.data();
            if (roomData.isLocked) {
                showMessage("This room is locked by the host.", true);
                return;
            }
            showMessage(`Joining room: ${roomId}`);
            try {
                const startMuted = joinMutedCheckbox.checked;
                const stream = await getLocalStream(startMuted);
                if (!stream) return;
                setupPeerConnection();
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                const offer = roomSnapshot.data().offer;
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await updateDoc(roomRef, { answer: { sdp: answer.sdp, type: answer.type } });
                await updateDoc(roomRef, { [`participants.${userId}`]: {
                    username: username,
                    isMuted: joinMutedCheckbox.checked,
                    isVideoOff: joinMutedCheckbox.checked
                }});
                candidatesListener = onSnapshot(collection(roomRef, 'candidates'), (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const candidate = new RTCIceCandidate(JSON.parse(change.doc.data().candidate));
                            await peerConnection.addIceCandidate(candidate);
                        }
                    });
                });
                listenForChat(roomRef);
                listenForParticipants();
                showMessage(`Successfully joined room ${roomId}!`);
                createRoomBtn.disabled = true;
                joinRoomBtn.disabled = true;
                hangupBtn.disabled = false;
                sendChatBtn.disabled = false;
            } catch (error) {
                console.error("Error joining room:", error);
                showMessage("Failed to join room. Please try again.", true);
            }
        };

        // Hang up
        const hangup = async () => {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            peerConnection = null;
            localStream = null;
            isScreenSharing = false;
            screenShareBtn.textContent = 'Screen Share';
            toggleVideoBtn.disabled = false;
            if (userId) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/active-users`, userId));
            }
            if (roomRef) {
                const roomSnapshot = await getDoc(roomRef);
                const participants = roomSnapshot.data()?.participants || {};
                if (participants[userId]) {
                    const newParticipants = { ...participants };
                    delete newParticipants[userId];
                    await updateDoc(roomRef, { participants: newParticipants });
                    if (Object.keys(newParticipants).length === 0) {
                        await deleteDoc(roomRef);
                        showMessage('Room has been automatically closed.', false);
                    } else {
                        showMessage(`${username} has left the room.`, false);
                    }
                }
            }
            if (roomSnapshotListener) roomSnapshotListener();
            if (candidatesListener) candidatesListener();
            if (chatListener) chatListener();
            if (participantsListener) participantsListener();
            roomSnapshotListener = null;
            candidatesListener = null;
            chatListener = null;
            participantsListener = null;
            roomIdInput.value = '';
            hideMessage();
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            hangupBtn.disabled = true;
            toggleAudioBtn.disabled = true;
            toggleVideoBtn.disabled = true;
            fullScreenBtn.disabled = true;
            sideBySideBtn.disabled = true;
            lockRoomBtn.disabled = true;
            videoQualitySelect.disabled = true;
            screenShareBtn.disabled = true;
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
            sendChatBtn.disabled = true;
            chatContainer.innerHTML = '';
            participantsList.innerHTML = 'No participants in this room.';
        };

        // Screen share
        const startScreenShare = async () => {
            if (!peerConnection) {
                showMessage("Please join a room before sharing your screen.", true);
                return;
            }
            if (isScreenSharing) {
                isScreenSharing = false;
                screenShareBtn.textContent = 'Screen Share';
                toggleVideoBtn.disabled = false;
                const selectedQuality = videoQualitySelect.value;
                const constraints = { audio: true, video: videoQualities[selectedQuality] };
                const newStream = await navigator.mediaDevices.getUserMedia(constraints);
                const newVideoTrack = newStream.getVideoTracks()[0];
                const newAudioTrack = newStream.getAudioTracks()[0];
                const videoSender = peerConnection.getSenders().find(sender => sender.track.kind === 'video');
                if (videoSender) videoSender.replaceTrack(newVideoTrack);
                const audioSender = peerConnection.getSenders().find(sender => sender.track.kind === 'audio');
                if (audioSender) audioSender.replaceTrack(newAudioTrack);
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = newStream;
                localStream = newStream;
            } else {
                isScreenSharing = true;
                screenShareBtn.textContent = 'Stop Sharing';
                toggleVideoBtn.disabled = true;
                const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                if (!displayStream) {
                    isScreenSharing = false;
                    screenShareBtn.textContent = 'Screen Share';
                    toggleVideoBtn.disabled = false;
                    return;
                }
                if (localStream) localStream.getTracks().forEach(track => track.stop());
                localStream = displayStream;
                const videoSender = peerConnection.getSenders().find(sender => sender.track.kind === 'video');
                const audioSender = peerConnection.getSenders().find(sender => sender.track.kind === 'audio');
                if (videoSender) videoSender.replaceTrack(localStream.getVideoTracks()[0]);
                if (audioSender && localStream.getAudioTracks().length > 0) {
                    audioSender.replaceTrack(localStream.getAudioTracks()[0]);
                } else if (audioSender) {
                    audioSender.replaceTrack(null);
                }
                localVideo.srcObject = localStream;
            }
        };

        // Toggle audio
        const toggleAudio = async () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                const isMuted = !audioTrack.enabled;
                audioTrack.enabled = isMuted;
                toggleAudioBtn.textContent = audioTrack.enabled ? "Mute Audio" : "Unmute Audio";
                toggleAudioBtn.classList.toggle('btn-toggle-active', !audioTrack.enabled);
                if (roomRef) {
                    await updateDoc(doc(roomRef, 'participants', userId), { isMuted: !audioTrack.enabled });
                }
            }
        };

        // Toggle video
        const toggleVideo = async () => {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                const isVideoOff = !videoTrack.enabled;
                videoTrack.enabled = isVideoOff;
                toggleVideoBtn.textContent = videoTrack.enabled ? "Mute Video" : "Unmute Video";
                toggleVideoBtn.classList.toggle('btn-toggle-active', !videoTrack.enabled);
                if (roomRef) {
                    await updateDoc(doc(roomRef, 'participants', userId), { isVideoOff: !videoTrack.enabled });
                }
            }
        };

        // Toggle room lock
        const toggleRoomLock = async () => {
            if (roomRef) {
                const roomSnapshot = await getDoc(roomRef);
                const isLocked = roomSnapshot.data()?.isLocked || false;
                await updateDoc(roomRef, { isLocked: !isLocked });
                lockRoomBtn.textContent = isLocked ? "Lock Room" : "Unlock Room";
                showMessage(isLocked ? "Room is now unlocked." : "Room is now locked.", false);
            }
        };

        // Start recording
        const startRecording = () => {
            if (!remoteVideo.srcObject) {
                showMessage("No remote stream to record.", true);
                return;
            }
            recordedChunks = [];
            const stream = remoteVideo.srcObject;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.getElementById('downloadRecording');
                a.style.display = 'block';
                a.href = url;
                a.download = `conference-recording-${Date.now()}.webm`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage("Recording downloaded successfully!");
            };
            mediaRecorder.start();
            showMessage("Recording started...");
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = false;
        };

        // Stop recording
        const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                showMessage("Recording stopped. Your download should start shortly.");
            }
        };

        // Send chat message
        const sendMessage = async (messageType = 'text', fileData = null) => {
            if (!roomRef) return;
            let messagePayload = {
                senderId: userId,
                senderUsername: username,
                timestamp: serverTimestamp(),
                type: messageType
            };
            if (messageType === 'text') {
                const message = chatInput.value.trim();
                if (message === "") return;
                messagePayload.text = message;
            } else if (messageType === 'file') {
                messagePayload.file = fileData;
            }
            const chatMessagesRef = collection(roomRef, 'chat-messages');
            await addDoc(chatMessagesRef, messagePayload);
            chatInput.value = '';
        };

        // Listen for chat messages
        const listenForChat = (roomDocRef) => {
            if (chatListener) chatListener();
            const chatMessagesRef = collection(roomDocRef, 'chat-messages');
            chatListener = onSnapshot(chatMessagesRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const messageData = change.doc.data();
                        displayMessage(messageData);
                    }
                });
            });
        };

        // Display chat message
        const displayMessage = (messageData) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.senderId === userId ? 'my-message' : 'other-message'}`;
            const senderName = messageData.senderUsername === username ? 'You' : messageData.senderUsername;
            if (messageData.type === 'text') {
                messageDiv.innerHTML = `<span class="font-bold">${senderName}:</span> ${messageData.text}`;
            } else if (messageData.type === 'file' && messageData.file) {
                const file = messageData.file;
                const isImage = file.type.startsWith('image/');
                const fileContent = `
                    <div class="flex flex-col">
                        <span class="font-bold">${senderName}:</span>
                        <a href="${file.data}" download="${file.name}" class="text-blue-400 hover:underline">
                            <i class="fas fa-file-download mr-1"></i>${file.name}
                        </a>
                    </div>
                `;
                messageDiv.innerHTML = isImage
                    ? `<div class="flex flex-col"><span class="font-bold">${senderName}:</span><img src="${file.data}" alt="${file.name}" class="mt-2 rounded-lg" style="max-width: 100%; max-height: 200px;"></div>`
                    : fileContent;
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Handle file upload
        const handleFileUpload = (file) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: event.target.result,
                };
                const oneMB = 1048576;
                if (file.size > oneMB) {
                    showMessage('File is too large. Max size is 1MB.', true);
                    return;
                }
                sendMessage('file', fileData);
            };
            reader.readAsDataURL(file);
        };

        // Listen for participants
        const listenForParticipants = () => {
            if (participantsListener) participantsListener();
            participantsList.innerHTML = '';
            participantsListener = onSnapshot(doc(db, `artifacts/${appId}/public/data/video-rooms/${roomIdInput.value}`), (snapshot) => {
                const roomData = snapshot.data();
                const participants = roomData?.participants || {};
                const participantIds = Object.keys(participants);
                if (participantIds.length > 0) {
                    participantsList.innerHTML = '';
                    participantIds.forEach(id => {
                        const participantData = participants[id];
                        const participantDiv = document.createElement('div');
                        participantDiv.className = 'flex items-center space-x-2 p-2 bg-[#3c3836] rounded-sm';
                        const participantName = participantData.username === username ? `${participantData.username} (You)` : participantData.username;
                        const audioIcon = participantData.isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
                        const videoIcon = participantData.isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
                        participantDiv.innerHTML = `
                            <i class="fas fa-user-circle text-lg"></i>
                            <span class="text-sm flex-1">${participantName}</span>
                            <span class="text-xs text-gray-400 space-x-2">${audioIcon} ${videoIcon}</span>
                        `;
                        participantsList.appendChild(participantDiv);
                    });
                } else {
                    participantsList.innerHTML = 'No participants in this room.';
                }
            });
        };

        // Listen for active users (user view)
        const listenForActiveUsers = () => {
            if (activeUsersListener) activeUsersListener();
            activeUsersList.innerHTML = 'Loading users...';
            const activeUsersRef = collection(db, `artifacts/${appId}/public/data/active-users`);
            activeUsersListener = onSnapshot(activeUsersRef, (snapshot) => {
                activeUsersList.innerHTML = '';
                const users = snapshot.docs.map(doc => doc.data().username);
                if (users.length > 0) {
                    users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-2 p-2 bg-[#3c3836] rounded-sm';
                        userDiv.innerHTML = `
                            <i class="fas fa-user-circle text-lg"></i>
                            <span class="text-sm flex-1">${user}</span>
                        `;
                        activeUsersList.appendChild(userDiv);
                    });
                } else {
                    activeUsersList.innerHTML = '<p class="text-gray-500 text-sm">No active users.</p>';
                }
            });
        };

        // Listen for rooms (admin view)
        const listenForAdminRooms = () => {
            if (adminRoomsListener) adminRoomsListener();
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            adminRoomsListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                adminActiveRoomsList.innerHTML = '';
                totalRooms.textContent = snapshot.size;
                if (snapshot.empty) {
                    adminActiveRoomsList.innerHTML = '<p class="text-gray-500 text-sm">No active rooms.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const roomData = doc.data();
                        const roomName = doc.id;
                        const numParticipants = Object.keys(roomData.participants || {}).length;
                        const isLocked = roomData.isLocked ? '<i class="fas fa-lock text-red-500"></i>' : '<i class="fas fa-unlock text-green-500"></i>';
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-sm hover:bg-[#504945] transition duration-150';
                        roomDiv.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <span>${isLocked}</span>
                                <div class="flex flex-col">
                                    <span class="font-semibold">${roomName}</span>
                                    <span class="text-xs text-gray-400">Participants: ${numParticipants}</span>
                                    <span class="text-xs text-gray-400">Created by: ${roomData.createdByUsername}</span>
                                </div>
                            </div>
                            <button data-room-id="${roomName}" class="delete-room-btn px-3 py-1 text-sm rounded-sm bg-red-600 text-white hover:bg-red-700">Delete</button>
                        `;
                        adminActiveRoomsList.appendChild(roomDiv);
                    });
                    document.querySelectorAll('.delete-room-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            passwordModalTitle.textContent = 'Confirm Room Deletion';
                            passwordModalText.textContent = `Enter the admin password to delete room ${e.target.dataset.roomId}.`;
                            confirmBtn.dataset.action = `delete-room:${e.target.dataset.roomId}`;
                            passwordModal.classList.remove('hidden');
                        });
                    });
                }
            });
        };

        // Listen for users (admin view)
        const listenForAdminUsers = () => {
            if (adminUsersListener) adminUsersListener();
            const activeUsersRef = collection(db, `artifacts/${appId}/public/data/active-users`);
            adminUsersListener = onSnapshot(activeUsersRef, (snapshot) => {
                adminActiveUsersList.innerHTML = '';
                totalUsers.textContent = snapshot.size;
                if (snapshot.empty) {
                    adminActiveUsersList.innerHTML = '<p class="text-gray-500 text-sm">No active users.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-2 p-2 bg-[#3c3836] rounded-sm';
                        userDiv.innerHTML = `
                            <i class="fas fa-user-circle text-lg"></i>
                            <span class="text-sm flex-1">${userData.username}</span>
                        `;
                        adminActiveUsersList.appendChild(userDiv);
                    });
                }
            });
        };

        // Check server status
        const checkServerStatus = async () => {
            try {
                const testDoc = doc(db, `artifacts/${appId}/public/data/test`);
                await getDoc(testDoc);
                serverStatus.textContent = 'Online';
                serverStatus.className = 'text-green-500';
            } catch (error) {
                serverStatus.textContent = 'Offline';
                serverStatus.className = 'text-red-500';
                showMessage('Server connection failed.', true);
            }
        };

        // Delete single room
        const deleteRoom = async (roomId) => {
            try {
                const roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomId);
                const chatMessagesRef = collection(roomRef, 'chat-messages');
                const chatSnapshot = await getDocs(chatMessagesRef);
                const chatDeletePromises = chatSnapshot.docs.map(chatDoc => deleteDoc(chatDoc.ref));
                await Promise.all(chatDeletePromises);
                await deleteDoc(roomRef);
                showMessage(`Room ${roomId} deleted successfully.`, false);
            } catch (error) {
                console.error('Error deleting room:', error);
                showMessage('Failed to delete room.', true);
            }
        };

        // Delete all rooms
        const deleteAllRooms = async () => {
            try {
                const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
                const roomsSnapshot = await getDocs(roomsCollectionRef);
                if (roomsSnapshot.empty) {
                    showMessage('No rooms to delete.', false);
                    return;
                }
                const deletePromises = roomsSnapshot.docs.map(async (roomDoc) => {
                    const chatMessagesRef = collection(roomDoc.ref, 'chat-messages');
                    const chatSnapshot = await getDocs(chatMessagesRef);
                    const chatDeletePromises = chatSnapshot.docs.map(chatDoc => deleteDoc(chatDoc.ref));
                    await Promise.all(chatDeletePromises);
                    await deleteDoc(roomDoc.ref);
                });
                await Promise.all(deletePromises);
                showMessage('All rooms deleted successfully.', false);
            } catch (error) {
                console.error('Error deleting rooms:', error);
                showMessage('Failed to delete rooms.', true);
            }
        };

        // Handle modal actions
        const handleModalAction = () => {
            const password = passwordInput.value;
            if (password !== 'max') {
                showMessage('Incorrect password.', true);
                passwordModal.classList.add('hidden');
                return;
            }
            const action = confirmBtn.dataset.action;
            if (action === 'delete-all') {
                deleteAllRooms();
            } else if (action.startsWith('delete-room:')) {
                const roomId = action.split(':')[1];
                deleteRoom(roomId);
            }
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
        };

        // Toggle side-by-side view
        const toggleSideBySide = () => {
            if (localVideo.style.width === '50%') {
                localVideo.style.width = '150px';
                localVideo.style.height = '112.5px';
                localVideo.style.position = 'absolute';
                localVideo.style.bottom = '1rem';
                localVideo.style.right = '1rem';
                remoteVideo.style.width = '100%';
                remoteVideo.style.height = '100%';
                remoteVideo.style.position = 'absolute';
                remoteVideo.style.top = '0';
                remoteVideo.style.left = '0';
            } else {
                localVideo.style.position = 'absolute';
                localVideo.style.width = '50%';
                localVideo.style.height = '100%';
                localVideo.style.top = '0';
                localVideo.style.left = '0';
                localVideo.style.bottom = 'auto';
                localVideo.style.right = 'auto';
                remoteVideo.style.position = 'absolute';
                remoteVideo.style.width = '50%';
                remoteVideo.style.height = '100%';
                remoteVideo.style.top = '0';
                remoteVideo.style.left = '50%';
            }
        };

        // Event Listeners
        window.onload = () => {
            initFirebase();
        };
        submitLoginBtn.addEventListener('click', handleLogin);
        usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        hangupBtn.addEventListener('click', hangup);
        toggleAudioBtn.addEventListener('click', toggleAudio);
        toggleVideoBtn.addEventListener('click', toggleVideo);
        screenShareBtn.addEventListener('click', startScreenShare);
        lockRoomBtn.addEventListener('click', toggleRoomLock);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);
        fileUploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file);
        });
        sendChatBtn.addEventListener('click', () => sendMessage('text'));
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage('text');
        });
        fullScreenBtn.addEventListener('click', () => {
            if (remoteVideo.requestFullscreen) remoteVideo.requestFullscreen();
        });
        sideBySideBtn.addEventListener('click', toggleSideBySide);
        videoQualitySelect.addEventListener('change', async () => {
            if (localStream) {
                const newQuality = videoQualitySelect.value;
                const newConstraints = { audio: true, video: videoQualities[newQuality] };
                try {
                    const newStream = await navigator.mediaDevices.getUserMedia(newConstraints);
                    const newVideoTrack = newStream.getVideoTracks()[0];
                    const oldVideoTrack = localStream.getVideoTracks()[0];
                    if (oldVideoTrack) oldVideoTrack.stop();
                    localStream.removeTrack(oldVideoTrack);
                    localStream.addTrack(newVideoTrack);
                    localVideo.srcObject = localStream;
                    const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(newVideoTrack);
                    showMessage(`Video quality set to ${newQuality}.`, false);
                } catch (error) {
                    console.error("Error setting video quality:", error);
                    showMessage("Failed to change video quality. Your device may not support it.", true);
                }
            }
        });
        volumeControl.addEventListener('input', (e) => {
            remoteVideo.volume = e.target.value / 100;
        });
        deleteAllRoomsBtn.addEventListener('click', () => {
            passwordModalTitle.textContent = 'Delete All Rooms';
            passwordModalText.textContent = 'To delete all rooms, please enter the administrator password.';
            confirmBtn.dataset.action = 'delete-all';
            passwordModal.classList.remove('hidden');
        });
        adminDeleteAllRoomsBtn.addEventListener('click', () => {
            passwordModalTitle.textContent = 'Delete All Rooms';
            passwordModalText.textContent = 'Enter the admin password to delete all rooms.';
            confirmBtn.dataset.action = 'delete-all';
            passwordModal.classList.remove('hidden');
        });
        switchToUserModeBtn.addEventListener('click', switchToUserMode);
        confirmSwitchBtn.addEventListener('click', handleSwitchToUserMode);
        cancelSwitchBtn.addEventListener('click', () => {
            usernameModal.classList.add('hidden');
            switchUsernameInput.value = '';
        });
        cancelBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
        });
        confirmBtn.addEventListener('click', handleModalAction);
    </script>
</body>
</html>
