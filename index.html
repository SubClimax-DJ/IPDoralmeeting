<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --gruvbox-bg: #282828;
            --gruvbox-fg: #ebdbb2;
            --gruvbox-red: #cc241d;
            --gruvbox-green: #98971a;
            --gruvbox-yellow: #d79921;
            --gruvbox-blue: #458588;
            --gruvbox-purple: #b16286;
            --gruvbox-aqua: #689d6a;
            --gruvbox-orange: #d65d0e;
            --gruvbox-gray: #a89984;
            --gruvbox-light-bg: #3c3836;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gruvbox-bg);
            color: var(--gruvbox-fg);
        }

        .gruvbox-card {
            background-color: var(--gruvbox-light-bg);
            border: 2px solid var(--gruvbox-gray);
        }

        .gruvbox-button {
            background-color: var(--gruvbox-green);
            color: var(--gruvbox-bg);
            transition: all 0.2s ease-in-out;
        }

        .gruvbox-button:hover {
            background-color: var(--gruvbox-aqua);
        }

        .gruvbox-input, .gruvbox-textarea {
            background-color: var(--gruvbox-bg);
            color: var(--gruvbox-fg);
            border: 1px solid var(--gruvbox-gray);
        }

        .gruvbox-input:focus, .gruvbox-textarea:focus {
            border-color: var(--gruvbox-blue);
            outline: none;
        }
        
        /* Time input specific style */
        .gruvbox-input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        .gruvbox-input[type="time"]::-moz-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }


        .gruvbox-delete-button {
            background-color: var(--gruvbox-red);
            color: var(--gruvbox-bg);
            transition: all 0.2s ease-in-out;
        }

        .gruvbox-delete-button:hover {
            background-color: var(--gruvbox-orange);
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: var(--gruvbox-green);
            color: var(--gruvbox-bg);
            border-radius: 8px;
            font-weight: 600;
            z-index: 100;
            animation: fadeInOut 3s forwards;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        
        .day-cell {
            min-height: 120px;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 640px) {
            .day-cell {
                min-height: 150px;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center py-12">

    <!-- Message Box Container -->
    <div id="message-container"></div>

    <!-- Main App Container -->
    <div class="container mx-auto px-4 w-full max-w-7xl">
        <div class="text-center mb-8">
            <!-- School Logo -->
            <img src="https://www.miamidadecountyauditorium.org/wp-content/uploads/2019/04/DoralAcademy_Web2019.jpg" alt="Doral Academy Logo" class="mx-auto h-20 mb-4 rounded-lg shadow-lg">
            <h1 class="text-4xl sm:text-5xl font-bold mb-2">Sports Calendar</h1>
            <p class="text-lg text-gray-400">View upcoming practices and games.</p>
        </div>

        <div id="auth-info" class="mb-4 text-center text-sm text-gray-400"></div>

        <!-- Login/Add Event Button -->
        <div class="flex justify-center items-center gap-4 mb-8">
            <button id="login-button" class="gruvbox-button rounded-lg px-6 py-3 font-semibold shadow-md">
                Log In to Edit
            </button>
            <button id="logout-button" class="bg-gray-500 text-white rounded-lg px-6 py-3 font-semibold shadow-md hidden">
                Log Out
            </button>
        </div>

        <!-- Password Modal (Initially Hidden) -->
        <div id="password-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-75 p-4">
            <div class="gruvbox-card rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-sm">
                <h2 class="text-2xl font-bold mb-4 text-center">Enter Password</h2>
                <input type="password" id="password-input" class="gruvbox-input w-full p-3 rounded-lg mb-4 text-center" placeholder="Password">
                <p id="password-error" class="text-gruvbox-red text-center mb-4 hidden">Incorrect password.</p>
                <div class="flex justify-center gap-4">
                    <button id="submit-password-button" class="gruvbox-button rounded-lg px-6 py-3 font-semibold">
                        Submit
                    </button>
                    <button id="close-password-modal" class="bg-gray-500 text-white rounded-lg px-6 py-3 font-semibold hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Single Calendar Display Section -->
        <div id="calendar-view" class="gruvbox-card p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month-button" class="gruvbox-button rounded-full p-3 font-bold">&lt;</button>
                <h2 id="month-title" class="text-3xl font-bold text-center flex-grow"></h2>
                <button id="next-month-button" class="gruvbox-button rounded-full p-3 font-bold">&gt;</button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
        </div>
        
        <!-- Add/Edit Event Section (Initially Hidden) -->
        <div id="edit-section" class="hidden mt-8 gruvbox-card p-6 rounded-2xl shadow-lg w-full max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-center">Add or Edit Event</h2>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="block mb-2 font-semibold">Event Title</label>
                    <input type="text" id="event-title" class="gruvbox-input w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="event-date" class="block mb-2 font-semibold">Date</label>
                    <input type="date" id="event-date" class="gruvbox-input w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="event-time" class="block mb-2 font-semibold">Time</label>
                    <input type="time" id="event-time" class="gruvbox-input w-full p-3 rounded-lg">
                </div>
                <div>
                    <label for="event-location" class="block mb-2 font-semibold">Location</label>
                    <input type="text" id="event-location" class="gruvbox-input w-full p-3 rounded-lg" placeholder="e.g. Main Gym">
                </div>
                <div>
                    <label for="event-description" class="block mb-2 font-semibold">Description</label>
                    <textarea id="event-description" class="gruvbox-textarea w-full p-3 rounded-lg" rows="4"></textarea>
                </div>
                <div>
                    <label for="event-color" class="block mb-2 font-semibold">Event Color</label>
                    <input type="color" id="event-color" class="w-full h-12 rounded-lg" value="#98971a">
                </div>

                <!-- Recurrence Options -->
                <div class="mt-8 pt-4 border-t border-gray-600">
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="recurrence-toggle" class="mr-2 h-4 w-4 text-gruvbox-green border-gray-300 rounded focus:ring-gruvbox-green">
                        <label for="recurrence-toggle" class="font-semibold">Enable Recurring Event</label>
                    </div>

                    <div id="recurrence-options" class="hidden space-y-4">
                        <div>
                            <label class="block mb-2 font-semibold">Repeat on:</label>
                            <div class="grid grid-cols-3 sm:grid-cols-7 gap-2">
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="0"> Sun</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="1"> Mon</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="2"> Tue</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="3"> Wed</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="4"> Thu</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="5"> Fri</label>
                                <label class="flex items-center"><input type="checkbox" class="recurrence-day mr-1" value="6"> Sat</label>
                            </div>
                        </div>
                        <div>
                            <label for="recurrence-weeks" class="block mb-2 font-semibold">For how many weeks?</label>
                            <input type="number" id="recurrence-weeks" class="gruvbox-input w-full p-3 rounded-lg" min="1" max="52" value="4">
                        </div>
                    </div>
                </div>

                <div class="flex justify-center gap-4">
                    <button type="submit" class="gruvbox-button rounded-lg px-6 py-3 font-semibold">
                        Save Event
                    </button>
                    <button type="button" id="delete-event-button" class="gruvbox-delete-button rounded-lg px-6 py-3 font-semibold hidden">
                        Delete Event
                    </button>
                </div>
            </form>
        </div>

        <!-- Event Details Modal (Initially Hidden) -->
        <div id="event-details-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-75 p-4">
            <div class="gruvbox-card rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-date-title" class="text-2xl font-bold"></h2>
                    <button id="close-event-details-modal" class="text-gruvbox-fg hover:text-gruvbox-red transition-colors font-bold text-2xl">
                        &times;
                    </button>
                </div>
                <div id="modal-events-list" class="space-y-4">
                    <!-- Events will be populated here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firebase debug logs
        setLogLevel('debug');

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            databaseURL: "https://video-meeting-e73eb-default-rtdb.firebaseio.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:699053568ddccb0c77c708",
            measurementId: "G-6TC6DG1KGC"
        };
        const appId = firebaseConfig.appId;

        // Initialize Firebase
        let app, db, auth;
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } else {
                console.error("Firebase config is missing. The app will run without database functionality.");
            }
        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
        }

        // DOM elements
        const calendarGridEl = document.getElementById('calendar-grid');
        const monthTitleEl = document.getElementById('month-title');
        const prevMonthButton = document.getElementById('prev-month-button');
        const nextMonthButton = document.getElementById('next-month-button');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const submitPasswordBtn = document.getElementById('submit-password-button');
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const editSection = document.getElementById('edit-section');
        const eventForm = document.getElementById('event-form');
        const eventIdInput = document.getElementById('event-id');
        const eventTitleInput = document.getElementById('event-title');
        const eventDateInput = document.getElementById('event-date');
        const eventTimeInput = document.getElementById('event-time');
        const eventLocationInput = document.getElementById('event-location');
        const eventDescriptionInput = document.getElementById('event-description');
        const eventColorInput = document.getElementById('event-color');
        const deleteEventButton = document.getElementById('delete-event-button');
        const authInfoEl = document.getElementById('auth-info');
        const messageContainer = document.getElementById('message-container');
        const eventDetailsModal = document.getElementById('event-details-modal');
        const modalDateTitleEl = document.getElementById('modal-date-title');
        const modalEventsListEl = document.getElementById('modal-events-list');
        const closeEventDetailsModalBtn = document.getElementById('close-event-details-modal');

        // New Recurrence elements
        const recurrenceToggle = document.getElementById('recurrence-toggle');
        const recurrenceOptionsDiv = document.getElementById('recurrence-options');
        const recurrenceDays = document.querySelectorAll('.recurrence-day');
        const recurrenceWeeksInput = document.getElementById('recurrence-weeks');


        let events = {};
        let isEditMode = false;
        let userId = null;
        let currentDate = new Date(); // State for the currently displayed month

        // Constants
        const PASSWORD = 'runfast';
        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const COLLECTION_NAME = 'events';
        const schoolYearEndMonth = 4; // May (0-indexed)

        // Utility to format date string
        const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const showMessage = (message) => {
            const msgEl = document.createElement('div');
            msgEl.className = 'message-box';
            msgEl.textContent = message;
            messageContainer.appendChild(msgEl);
            setTimeout(() => {
                messageContainer.removeChild(msgEl);
            }, 3000);
        };

        const showEventDetails = (dateString) => {
            const dateObj = new Date(dateString);
            const formattedDate = `${MONTHS[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
            modalDateTitleEl.textContent = formattedDate;
            modalEventsListEl.innerHTML = '';
            
            const dayEvents = events[dateString] || [];
            if (dayEvents.length > 0) {
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('p-4', 'rounded-lg', 'gruvbox-card', 'space-y-2');
                    eventDiv.style.borderColor = event.color || 'var(--gruvbox-gray)';
                    eventDiv.innerHTML = `
                        <h3 class="text-lg font-bold" style="color: ${event.color || 'var(--gruvbox-green)'}">${event.title}</h3>
                        ${event.time ? `<p class="text-sm text-gray-400">Time: ${event.time}</p>` : ''}
                        ${event.location ? `<p class="text-sm text-gray-400">Location: ${event.location}</p>` : ''}
                        <p class="text-base">${event.description || 'No description provided.'}</p>
                    `;
                    modalEventsListEl.appendChild(eventDiv);
                });
            } else {
                const noEventsMsg = document.createElement('p');
                noEventsMsg.classList.add('text-center', 'text-gray-400');
                noEventsMsg.textContent = 'No events for this date.';
                modalEventsListEl.appendChild(noEventsMsg);
            }

            eventDetailsModal.classList.remove('hidden');
        };

        const closeEventDetailsModal = () => {
            eventDetailsModal.classList.add('hidden');
        };

        const handleDayClick = (dateString) => {
            if (isEditMode) {
                showEventForm(dateString);
            } else {
                showEventDetails(dateString);
            }
        };

        // Render the calendar for a given month
        const renderCalendar = (date) => {
            const month = date.getMonth();
            const year = date.getFullYear();
            calendarGridEl.innerHTML = '';
            monthTitleEl.textContent = `${MONTHS[month]} ${year}`;
            
            // Add day headers
            DAYS_OF_WEEK.forEach(day => {
                const header = document.createElement('div');
                header.classList.add('font-bold', 'p-2', 'text-sm', 'md:text-base', 'text-gray-400');
                header.textContent = day;
                calendarGridEl.appendChild(header);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = formatDate(new Date());

            // Add empty placeholders for the first week
            for (let i = 0; i < firstDay; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('w-full', 'day-cell', 'bg-gray-800', 'rounded-lg', 'p-2');
                calendarGridEl.appendChild(dayEl);
            }

            // Add the days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const dateString = formatDate(new Date(year, month, i));

                const dayEl = document.createElement('div');
                dayEl.classList.add(
                    'w-full', 'day-cell', 'p-2', 'rounded-lg', 'cursor-pointer', 'transition-colors', 'duration-200',
                    'gruvbox-card', 'hover:bg-gray-600', 'border-gruvbox-light-bg'
                );
                
                if (dateString === today) {
                    dayEl.classList.add('border-2', 'border-gruvbox-yellow', 'shadow-lg');
                }

                dayEl.onclick = () => handleDayClick(dateString);

                const dayNumberEl = document.createElement('div');
                dayNumberEl.classList.add('font-bold', 'text-sm', 'text-gruvbox-yellow');
                dayNumberEl.textContent = i;
                dayEl.appendChild(dayNumberEl);

                const eventContainer = document.createElement('div');
                eventContainer.classList.add('space-y-1', 'mt-1', 'overflow-y-auto', 'text-sm', 'flex-grow');
                dayEl.appendChild(eventContainer);

                const dayEvents = events[dateString] || [];
                dayEvents.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.classList.add(
                        'text-gruvbox-bg', 'rounded-md', 'px-1', 'py-0.5', 'text-xs', 'font-medium',
                        'truncate', 'cursor-pointer'
                    );
                    eventEl.style.backgroundColor = event.color || 'var(--gruvbox-green)';
                    eventEl.textContent = `${event.time ? event.time + ' - ' : ''}${event.title}`;
                    if (isEditMode) {
                        eventEl.onclick = (e) => {
                            e.stopPropagation();
                            showEventForm(dateString, event.id, event);
                        };
                    }
                    eventContainer.appendChild(eventEl);
                });

                calendarGridEl.appendChild(dayEl);
            }
        };

        // Firestore listener for real-time updates
        const setupFirestoreListener = async () => {
            if (!db) return;
            try {
                const publicCollectionRef = collection(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}`);
                onSnapshot(publicCollectionRef, (snapshot) => {
                    const newEvents = {};
                    snapshot.forEach(doc => {
                        const eventData = { id: doc.id, ...doc.data() };
                        const dateString = eventData.date;
                        if (!newEvents[dateString]) {
                            newEvents[dateString] = [];
                        }
                        newEvents[dateString].push(eventData);
                    });
                    
                    // Sort events by date and time
                    for (const date in newEvents) {
                        newEvents[date].sort((a, b) => {
                            if (a.time && b.time) return a.time.localeCompare(b.time);
                            if (a.time) return -1;
                            if (b.time) return 1;
                            return 0;
                        });
                    }
                    
                    events = newEvents;
                    renderCalendar(currentDate);
                });
            } catch (error) {
                console.error("Error setting up Firestore listener:", error);
                // Graceful degradation: The app will run without real-time updates.
            }
        };

        // Show/Hide password modal
        const showPasswordModal = () => {
            passwordModal.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
        };

        const hidePasswordModal = () => {
            passwordModal.classList.add('hidden');
        };

        // Handle password submission
        const handlePasswordSubmit = () => {
            if (passwordInput.value === PASSWORD) {
                isEditMode = true;
                hidePasswordModal();
                editSection.classList.remove('hidden');
                loginButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                authInfoEl.textContent = `Editing enabled. User ID: ${userId || 'anonymous'}`;
                renderCalendar(currentDate);
                showMessage('Editing enabled!');
            } else {
                passwordError.classList.remove('hidden');
            }
        };

        const handleLogout = async () => {
            if (auth) {
                await signOut(auth);
            }
            isEditMode = false;
            editSection.classList.add('hidden');
            loginButton.classList.remove('hidden');
            logoutButton.classList.add('hidden');
            authInfoEl.textContent = `Signed in anonymously.`;
            renderCalendar(currentDate);
            showMessage('Logged out successfully.');
        };

        // Show event form with prepopulated data or for a new event
        const showEventForm = (dateString, eventId = null, eventData = null) => {
            eventForm.reset();
            eventIdInput.value = '';
            deleteEventButton.classList.add('hidden');
            
            eventDateInput.value = dateString;
            eventColorInput.value = '#98971a';
            eventTimeInput.value = '';
            eventLocationInput.value = '';
            
            recurrenceToggle.checked = false;
            recurrenceOptionsDiv.classList.add('hidden');
            recurrenceDays.forEach(day => day.checked = false);
            recurrenceWeeksInput.value = 4;

            if (eventData) {
                eventIdInput.value = eventId;
                eventTitleInput.value = eventData.title || '';
                eventDescriptionInput.value = eventData.description || '';
                eventColorInput.value = eventData.color || '#98971a';
                eventTimeInput.value = eventData.time || '';
                eventLocationInput.value = eventData.location || '';
                deleteEventButton.classList.remove('hidden');
            }

            editSection.scrollIntoView({ behavior: 'smooth' });
            eventTitleInput.focus();
        };

        // Handle form submission
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (!db) {
                console.error("Database not available.");
                return;
            }
            if (!isEditMode) {
                console.error("Not authorized to edit events.");
                return;
            }
            
            const eventId = eventIdInput.value;
            const eventData = {
                title: eventTitleInput.value,
                date: eventDateInput.value,
                time: eventTimeInput.value,
                location: eventLocationInput.value,
                description: eventDescriptionInput.value,
                color: eventColorInput.value,
                ownerId: userId // Store the user ID for potential future use
            };

            try {
                if (recurrenceToggle.checked && !eventId) {
                    // Create recurring events
                    const startDate = new Date(eventData.date);
                    const weeksToRepeat = parseInt(recurrenceWeeksInput.value);
                    const selectedDays = Array.from(recurrenceDays)
                        .filter(day => day.checked)
                        .map(day => parseInt(day.value));

                    if (selectedDays.length === 0 || weeksToRepeat <= 0) {
                        showMessage('Please select at least one day and a positive number of weeks for recurring events.');
                        return;
                    }
                    
                    let count = 0;
                    for (let i = 0; i < weeksToRepeat; i++) {
                        selectedDays.forEach(dayOfWeek => {
                            const newDate = new Date(startDate);
                            const dayDiff = dayOfWeek - startDate.getDay();
                            newDate.setDate(startDate.getDate() + dayDiff + (i * 7));
                            
                            const newEventData = {
                                ...eventData,
                                date: formatDate(newDate)
                            };
                            addDoc(collection(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}`), newEventData);
                            count++;
                        });
                    }
                    showMessage(`${count} events created successfully!`);
                } else if (eventId) {
                    // Update a single existing event
                    const docRef = doc(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}/${eventId}`);
                    await updateDoc(docRef, eventData);
                    showMessage('Event updated successfully!');
                } else {
                    // Create a single new event
                    await addDoc(collection(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}`), eventData);
                    showMessage('Event saved successfully!');
                }
                eventForm.reset();
                showEventForm(eventDateInput.value); // Reset form for next entry
            } catch (e) {
                console.error("Error saving event:", e);
                showMessage('Error saving event. Please try again.');
            }
        };

        // Handle event deletion
        const handleDeleteEvent = async () => {
            if (!db) {
                console.error("Database not available.");
                return;
            }
            const eventId = eventIdInput.value;
            if (!eventId) return;

            // Custom confirmation modal logic
            const confirmDelete = await new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4';
                modal.innerHTML = `
                    <div class="gruvbox-card rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-sm">
                        <h2 class="text-2xl font-bold mb-4 text-center">Confirm Deletion</h2>
                        <p class="text-center mb-4">Are you sure you want to delete this event?</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-delete-button" class="gruvbox-delete-button rounded-lg px-6 py-3 font-semibold">
                                Delete
                            </button>
                            <button id="cancel-delete-button" class="bg-gray-500 text-white rounded-lg px-6 py-3 font-semibold hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirm-delete-button').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('cancel-delete-button').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });

            if (confirmDelete) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}/${eventId}`));
                    eventForm.reset();
                    showEventForm(eventDateInput.value); // Reset form
                    showMessage('Event deleted successfully!');
                } catch (e) {
                    console.error("Error deleting event:", e);
                }
            }
        };
        
        // Navigation functions
        const showPreviousMonth = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            if (currentDate.getFullYear() < new Date().getFullYear() || 
                (currentDate.getFullYear() === new Date().getFullYear() && currentDate.getMonth() < new Date().getMonth())) {
                currentDate = new Date(); // Don't go back before the current month
            }
            renderCalendar(currentDate);
        };

        const showNextMonth = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            // Limit navigation up to next May
            const nextSchoolYearEnd = new Date().getFullYear() + (new Date().getMonth() > schoolYearEndMonth ? 1 : 0);
            if (currentDate.getFullYear() > nextSchoolYearEnd || 
                (currentDate.getFullYear() === nextSchoolYearEnd && currentDate.getMonth() > schoolYearEndMonth)) {
                currentDate.setMonth(currentDate.getMonth() - 1); // Stay at the last allowed month
            }
            renderCalendar(currentDate);
        };

        // Event listeners
        prevMonthButton.addEventListener('click', showPreviousMonth);
        nextMonthButton.addEventListener('click', showNextMonth);
        loginButton.addEventListener('click', showPasswordModal);
        logoutButton.addEventListener('click', handleLogout);
        closePasswordModalBtn.addEventListener('click', hidePasswordModal);
        submitPasswordBtn.addEventListener('click', handlePasswordSubmit);
        closeEventDetailsModalBtn.addEventListener('click', closeEventDetailsModal);
        eventForm.addEventListener('submit', handleFormSubmit);
        deleteEventButton.addEventListener('click', handleDeleteEvent);
        
        // New: Toggle recurrence options
        recurrenceToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                recurrenceOptionsDiv.classList.remove('hidden');
                // Hide single event date input, as it will be derived from recurrence
                eventDateInput.disabled = true;
                eventDateInput.required = false;
            } else {
                recurrenceOptionsDiv.classList.add('hidden');
                eventDateInput.disabled = false;
                eventDateInput.required = true;
            }
        });

        // Initial setup
        const init = async () => {
            if (auth) {
                try {
                    // We don't have an initial auth token on GitHub Pages, so we sign in anonymously
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                    authInfoEl.textContent = `Signed in anonymously.`;
                    loginButton.textContent = "Log In to Edit";
                } catch (error) {
                    console.error("Firebase auth failed:", error);
                    authInfoEl.textContent = "Authentication failed. App will be read-only.";
                }
            }
            renderCalendar(currentDate);
            setupFirestoreListener();
        };

        window.onload = init;
    </script>
</body>
</html>
